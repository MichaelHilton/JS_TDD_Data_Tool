<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Diff</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="jquery-2.1.0.js"></script>
</head>
<body>

  <div id="settings">
    <h1>Diff</h1>
    <label><input type="radio" name="diff_type" value="diffChars" checked> Chars</label>
    <label><input type="radio" name="diff_type" value="diffWords"> Words</label>
    <label><input type="radio" name="diff_type" value="diffLines"> Lines</label>
  </div>

  <a href="https://github.com/kpdecker/jsdiff" class="source">github.com/kpdecker/jsdiff</a>

  <table>
    <tr>
      <td contenteditable="true" id="a">restaurant</td>
      <td contenteditable="true" id="b">aura</td>
      <td><pre id="result"></pre></td>
    </tr>
  </table>

  <div id="bottomBar" >
    Source Events
    <div id="allEvents" >
    </div>
  </div>

  <script src="diff.js"></script>
  <script defer>
    var lastUpdate = 'B';
    var a = document.getElementById('a');
    var b = document.getElementById('b');
    var result = document.getElementById('result');

    function changed() {
      var diff = JsDiff[window.diffType](a.textContent, b.textContent);
      var fragment = document.createDocumentFragment();
      for (var i=0; i < diff.length; i++) {

        if (diff[i].added && diff[i + 1] && diff[i + 1].removed) {
          var swap = diff[i];
          diff[i] = diff[i + 1];
          diff[i + 1] = swap;
        }

        var node;
        if (diff[i].removed) {
          node = document.createElement('del');
          node.appendChild(document.createTextNode(diff[i].value));
        } else if (diff[i].added) {
          node = document.createElement('ins');
          node.appendChild(document.createTextNode(diff[i].value));
        } else {
          node = document.createTextNode(diff[i].value);
        }
        fragment.appendChild(node);
      }

      result.textContent = '';
      result.appendChild(fragment);
    }

    window.onload = function() {
      onDiffTypeChange(document.querySelector('#settings [name="diff_type"]:checked'));
      changed();
    };

    a.onpaste = a.onchange =
    b.onpaste = b.onchange = changed;

    if ('oninput' in a) {
      a.oninput = b.oninput = changed;
    } else {
      a.onkeyup = b.onkeyup = changed;
    }

    function onDiffTypeChange(radio) {
      window.diffType = radio.value;
      document.title = "Diff " + radio.value.slice(4);
    }

    var radio = document.getElementsByName('diff_type');
    for (var i = 0; i < radio.length; i++) {
      radio[i].onchange = function(e) {
        onDiffTypeChange(e.target);
        changed();
      }
    }

    function decodeAndSet(Idx){
      if(lastUpdate == 'B'){
        $("#a").empty().text(allJSONData[Idx].currText);
        lastUpdate = "A";
      }else{
        $("#b").empty().text(allJSONData[Idx].currText);
        lastUpdate = "B";
      }
      changed();
    }


  </script>
  <script>

    var allJSONData = [];

    var fileNames = {};

    function checkAndSet(fileName) {
      if (!(typeof fileName === "undefined")){ 
        if(fileName.indexOf(".java") > -1){
          AllFiles[fileName] = 1;
        }else{
          AllFiles["other"] = 1;
        }
      }
    }

    function setupFileDivs(AllFiles){
      console.log(AllFiles);
    }

    function getSafePath(path){
      return path.replace(/\//g, '').replace(/\./g, '');
    }

    function addColumn(event,key){
      $.each( AllFiles, function( key1, val1 ) {
        if(event.entityAddress === key1.entityAddress){
         $('#'+getSafePath(event.entityAddress)).append("<div class='eventDiv' id='" + event.eventType + "' onClick='decodeAndSet(" +key+ ")'></div>");  

       }else{
        $('#'+getSafePath(val.entityAddress)).append("<div class='placeHolder' id='" + val.eventType + "'></div>");
      }
    });
    }

    function addPlaceHolders(currRow, divClass, idx){
      $.each(fileNames, function( key, val ) {
        if(currRow === key){

        }else{
          if(key === 'TDDCycles'){
        $('#'+getSafePath(key)).append("<div class='" + divClass + "' onClick='addTDDCycle(" +idx+ ")'></div>");
          }else{
             $('#'+getSafePath(key)).append("<div class='" + divClass + "'></div>");
          }
        //   if(key === 'TDDCycles'){
        //     $('#'+getSafePath(key)).append("<div class='" + divClass + "'   onClick='addTDDCycle(" +key+ ")></div>");
        //   }else{
        //   $('#'+getSafePath(key)).append("<div class='" + divClass + "'></div>");
        // }
        }
      });
    }

    function addTDDCycle(idx){
      console.log(idx);
    }

    //precondition: key refers to event on java file
    function isMiddleJavaTextChangeEvent(key, allJSONData){

      var currentEvent = allJSONData[key];
      var previousEvent = allJSONData[key - 1];
      var nextEvent = allJSONData[key + 1];

      var isFirstEvent = key === 0;
      var isLastEvent = key === allJSONData.length - 1;

      if(currentEvent.eventType != "textChange")
        return false;

      if(isFirstEvent || previousEvent.eventType != "textChange")
        return false;

      if (isLastEvent || nextEvent.eventType != "textChange")
        return false;

      return true;
    }

    function addEventDiv(divId, divClass, eventType, key){
      $('#'+divId).append("<div class='" + divClass + "' id='" + eventType + "' onClick='decodeAndSet(" +key+ ")'></div>");
    }

    function addEvent(event,key){
      //ADD LENGTH TO DIV
      //allEvents
      // var currWidth = $("#allEvents").width();
      // $("#allEvents").width(currWidth + 11);

      // $("#allEvents").width( function(index, width) {
      //   return width + 11;
      // });

if (!(typeof event.entityAddress === "undefined")){ 
  if(event.entityAddress.indexOf(".java") > -1){

   if (isMiddleJavaTextChangeEvent(key, allJSONData)) {
    addEventDiv(getSafePath(event.entityAddress), "smallEventDiv", event.eventType, key);
    addPlaceHolders(event.entityAddress, "smallPlaceHolder",key);
  }else{
    addEventDiv(getSafePath(event.entityAddress), "eventDiv", event.eventType, key);
    addPlaceHolders(event.entityAddress, "placeHolder",key); 
  }

}else{
  addEventDiv("events", "eventDiv", event.eventType, key);
  addPlaceHolders("events", "placeHolder",key);
}
}else{
  addEventDiv("events", "eventDiv", event.eventType, key);
  addPlaceHolders("events", "placeHolder",key);
}


}

function findAllFiles(allJSONData){

  fileNames["TDDCycles"] = 1;

  $.each( allJSONData, function( key, val ) {
   if (!(typeof val.entityAddress === "undefined")){ 
    if(val.entityAddress.indexOf(".java") > -1){
      fileNames[val.entityAddress] = 1;
    }else{
      fileNames["events"] = 1;
    }
  }

});
  return(fileNames);
}


$(document).ready(function(){
  $.getJSON( "intermediateJSON.json", function( data ) {
   allJSONData = data;
   var items = [];
   var fileNames = findAllFiles(allJSONData);
   console.log(fileNames);
   $.each(fileNames, function( key, val ) {
    $('#allEvents').append("<div class='rowContainer' id='"+key+"Row'><div class='rowLabel'>"+key+"</div><div class='fileRow' id='" + getSafePath(key) + "' ></div></div>");   
  });

   $.each( allJSONData, function( key, val ) {
    addEvent(val,key);
  });

 });
});




</script>
</body>
</html>
